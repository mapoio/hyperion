# Story 2.1: Zap Logger Adapter

## Status
**✅ Completed** (Approved: 2025-10-02, Started: 2025-10-02, Completed: 2025-10-02)

## Story
**As a** framework user,
**I want** production-ready structured logging using Zap,
**so that** I can have high-performance, configurable logging in my applications

## Acceptance Criteria
1. Zap adapter implements `hyperion.Logger` interface
2. Support JSON and Console encoders
3. Dynamic log level adjustment at runtime
4. File output with rotation (lumberjack integration)
5. Configuration integration via `hyperion.Config`
6. Test coverage >= 80%

## Tasks / Subtasks

- [x] Implement `zapLogger` struct (AC: 1)
  - [x] Create struct wrapping `*zap.SugaredLogger`
  - [x] Ensure interface compliance with `var _ hyperion.Logger = (*zapLogger)(nil)`
  - [x] Document struct in godoc format

- [x] Implement `hyperion.Logger` interface methods (AC: 1)
  - [x] Implement `Debug(msg string, fields ...any)` using `Debugw()`
  - [x] Implement `Info(msg string, fields ...any)` using `Infow()`
  - [x] Implement `Warn(msg string, fields ...any)` using `Warnw()`
  - [x] Implement `Error(msg string, fields ...any)` using `Errorw()`
  - [x] Implement `Fatal(msg string, fields ...any)` using `Fatalw()`
  - [x] Implement `With(fields ...any) Logger` returning new logger with fields
  - [x] Implement `WithError(err error) Logger` adding error field
  - [x] Implement `SetLevel(level LogLevel)` for dynamic level changes
  - [x] Implement `GetLevel() LogLevel` to retrieve current level
  - [x] Implement `Sync() error` to flush buffered logs

- [x] Add encoder support (AC: 2)
  - [x] Implement JSON encoder configuration
  - [x] Implement Console encoder configuration
  - [x] Allow encoder selection via config

- [x] Implement file rotation support (AC: 4)
  - [x] Integrate `gopkg.in/natefinch/lumberjack.v2`
  - [x] Configure max file size (MB)
  - [x] Configure max backup count
  - [x] Configure max age (days)
  - [x] Support compression of rotated logs

- [x] Add configuration integration (AC: 5)
  - [x] Define configuration structure for Zap settings
  - [x] Read log level from config (`log.level`)
  - [x] Read encoding from config (`log.encoding` - json/console)
  - [x] Read output path from config (`log.output` - stdout/stderr/file path)
  - [x] Read file rotation settings from config (`log.file.*`)
  - [x] Provide sensible defaults when config missing

- [x] Create constructor with config support
  - [x] Implement `NewZapLogger(cfg hyperion.Config) (hyperion.Logger, error)`
  - [x] Handle missing config gracefully (use defaults)
  - [x] Validate configuration values
  - [x] Return appropriate errors for invalid config

- [x] Create `module.go` for fx integration
  - [x] Define `Module = fx.Module("hyperion.adapter.zap", ...)`
  - [x] Use `fx.Provide` with `fx.Annotate` for interface binding
  - [x] Bind to `hyperion.Logger` interface using `fx.As(new(hyperion.Logger))`
  - [x] Document module usage in comments

- [x] Write unit tests (>80% coverage) (AC: 6)
  - [x] Test all Logger interface methods
  - [x] Test JSON encoder output
  - [x] Test Console encoder output
  - [x] Test dynamic level changes
  - [x] Test `With()` field chaining
  - [x] Test `WithError()` error logging
  - [x] Test `Sync()` flushing
  - [x] Use table-driven tests where appropriate
  - [x] Place tests in `adapter/zap/logger_test.go`

- [x] Write integration tests
  - [x] Test file output and rotation
  - [x] Test config integration with real config provider
  - [x] Test encoder switching via config
  - [x] Verify log file creation and rotation behavior
  - [x] Place integration tests in `adapter/zap/integration_test.go`

- [x] Write godoc documentation (AC: all)
  - [x] Create `adapter/zap/doc.go` with package-level documentation
  - [x] Document all exported types and functions
  - [x] Include usage examples in documentation
  - [x] Follow godoc conventions

## Dev Notes

### Architecture Context

This story implements the **Zap Logger Adapter**, which provides production-ready structured logging as the first essential adapter in Epic 2. It wraps the Zap library to implement the `hyperion.Logger` interface defined in Epic 1.

[Source: docs/prd/epic-2-essential-adapters.md#1-zap-logger-adapter]

### Technology Stack

**Library: Zap (go.uber.org/zap)**
- Blazing fast structured logging
- Zero allocation logging paths
- Flexible output configuration
- Production-proven at Uber
- Dynamic level adjustment support

**Planned Version**: `go.uber.org/zap v1.27.0+`

[Source: docs/architecture/tech-stack.md#logging-zap-adapterzap]

**Why Zap?**
- High performance with minimal overhead (1M+ logs/sec throughput)
- Near-zero allocation for structured logging
- Production-proven at scale
- Flexible configuration options

[Source: docs/architecture/tech-stack.md#performance-characteristics]

**File Rotation Library**: `gopkg.in/natefinch/lumberjack.v2`
- Automatic log rotation by size
- Configurable backup retention
- Compression support for rotated logs

### Core Interface to Implement

The adapter must implement the `hyperion.Logger` interface:

```go
type Logger interface {
    Debug(msg string, fields ...any)
    Info(msg string, fields ...any)
    Warn(msg string, fields ...any)
    Error(msg string, fields ...any)
    Fatal(msg string, fields ...any)
    With(fields ...any) Logger
    WithError(err error) Logger
    SetLevel(level LogLevel)
    GetLevel() LogLevel
    Sync() error
}

type LogLevel int

const (
    DebugLevel LogLevel = iota
    InfoLevel
    WarnLevel
    ErrorLevel
    FatalLevel
)
```

[Source: hyperion/logger.go]

### File Locations & Structure

**Package Location**: `adapter/zap/`

**File Structure** (based on source tree guide):
```
adapter/zap/
├── go.mod                 # Independent module
├── go.sum
├── logger.go              # zapLogger implementation
├── module.go              # fx.Module export
├── logger_test.go         # Unit tests
├── integration_test.go    # Integration tests
├── doc.go                 # Package documentation
└── README.md              # Usage documentation
```

[Source: docs/architecture/source-tree.md#adapter-packages]

### Implementation Design

**zapLogger Struct**:
```go
type zapLogger struct {
    *zap.SugaredLogger
    atom zap.AtomicLevel  // For dynamic level changes
}

func (l *zapLogger) Debug(msg string, fields ...any) {
    l.Debugw(msg, fields...)
}

func (l *zapLogger) Info(msg string, fields ...any) {
    l.Infow(msg, fields...)
}

// ... implement all Logger methods
```

[Source: docs/prd/epic-2-essential-adapters.md#interface-implementation]

### Configuration Specification

**Configuration Structure**:
```yaml
log:
  level: info              # debug, info, warn, error
  encoding: json          # json or console
  output: stdout          # stdout, stderr, or file path
  file:
    path: /var/log/app.log
    max_size: 100         # MB
    max_backups: 3
    max_age: 7            # days
```

[Source: docs/prd/epic-2-essential-adapters.md#configuration-example]

**Config Keys**:
- `log.level` → Maps to `zapcore.Level`
- `log.encoding` → "json" or "console"
- `log.output` → stdout/stderr or file path
- `log.file.max_size` → Max file size in MB before rotation
- `log.file.max_backups` → Number of old files to keep
- `log.file.max_age` → Max days to retain old log files

### Module Export Pattern

The adapter must export an fx.Module:

```go
// module.go
package zap

import (
    "go.uber.org/fx"
    "github.com/mapoio/hyperion"
)

var Module = fx.Module("hyperion.adapter.zap",
    fx.Provide(
        fx.Annotate(
            NewZapLogger,
            fx.As(new(hyperion.Logger)),
        ),
    ),
)
```

[Source: docs/architecture/source-tree.md#adapter-module-pattern]

### Dependencies

**Required Go modules**:
- `go.uber.org/zap` v1.27.0+ - Core logging library
- `gopkg.in/natefinch/lumberjack.v2` - Log rotation
- `go.uber.org/fx` - Dependency injection (from core)
- `github.com/mapoio/hyperion` - Core interfaces

**Module Declaration** (`adapter/zap/go.mod`):
```
module github.com/mapoio/hyperion/adapter/zap

go 1.24

require (
    github.com/mapoio/hyperion v0.0.0
    go.uber.org/zap v1.27.0
    gopkg.in/natefinch/lumberjack.v2 v2.2.1
)
```

**Workspace Integration**:
After creating the module, add to workspace:
```bash
go work use ./adapter/zap
```

[Source: docs/architecture/source-tree.md#adding-a-new-adapter]

### Coding Standards

**Import Order** (3 groups):
```go
import (
    // Standard library
    "fmt"
    "os"

    // Third-party
    "go.uber.org/fx"
    "go.uber.org/zap"
    "go.uber.org/zap/zapcore"
    "gopkg.in/natefinch/lumberjack.v2"

    // Framework core
    "github.com/mapoio/hyperion"
)
```

[Source: docs/architecture/coding-standards.md#import-order]

**Naming Conventions**:
- Package name: `zap` (lowercase, named after library)
- Implementation struct: `zapLogger` (not exported)
- Constructor: `NewZapLogger` (exported)

**Error Handling**:
- Always check errors from Zap operations
- Use `fmt.Errorf` with `%w` for error wrapping
- Constructor should return descriptive errors for invalid config

[Source: docs/architecture/coding-standards.md#error-handling]

### Testing Requirements

**Test Coverage**: >= 80% (as specified in AC 6)

[Source: docs/prd/epic-2-essential-adapters.md#success-criteria]

**Unit Test Location**: `adapter/zap/logger_test.go`

**Testing Standards**:
- Test files: `*_test.go`
- Test functions: `TestFunctionName`
- Use table-driven tests for multiple scenarios
- Use `t.Helper()` for test helper functions
- Run with race detector: `go test -race`

**Test Structure Example**:
```go
func TestZapLogger_Info(t *testing.T) {
    tests := []struct {
        name     string
        msg      string
        fields   []any
        expected string
    }{
        {"simple message", "test", nil, `"msg":"test"`},
        {"with fields", "test", []any{"key", "value"}, `"key":"value"`},
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Test implementation
        })
    }
}
```

**Integration Test Location**: `adapter/zap/integration_test.go`

**Integration Test Scope**:
- Test actual file writing and rotation
- Test config integration with Viper adapter
- Verify log file creation with correct permissions
- Test rotation behavior with real files

[Source: docs/architecture/coding-standards.md#testing]
[Source: docs/architecture.md#13-testing-strategy]

### Documentation Requirements

**Package Documentation** (`doc.go`):
```go
// Package zap provides a Zap-based implementation of hyperion.Logger interface.
//
// This adapter wraps go.uber.org/zap to provide high-performance structured
// logging with support for JSON and Console encoders, dynamic level adjustment,
// and file rotation via lumberjack.
//
// Example usage:
//
//     app := fx.New(
//         viper.Module,  // Provides Config
//         zap.Module,    // Provides Logger
//         fx.Invoke(func(logger hyperion.Logger) {
//             logger.Info("application started", "version", "1.0.0")
//         }),
//     )
//
package zap
```

**Function Documentation**:
- Document all exported functions
- Start comments with the function name
- End with a period
- Include parameter descriptions and error conditions

[Source: docs/architecture/coding-standards.md#documentation]

### Performance Expectations

**Expected Performance** (from tech stack):
- **Throughput**: 1M+ logs/sec
- **Allocation**: Near-zero for structured logging
- **Latency**: <100ns per log call (cached logger)

**Overhead Target**: < 5% vs native Zap

[Source: docs/architecture/tech-stack.md#adapter-performance-expected]
[Source: docs/prd/epic-2-essential-adapters.md#success-criteria]

### Level Mapping

Map `hyperion.LogLevel` to `zapcore.Level`:

```go
func toZapLevel(level hyperion.LogLevel) zapcore.Level {
    switch level {
    case hyperion.DebugLevel:
        return zapcore.DebugLevel
    case hyperion.InfoLevel:
        return zapcore.InfoLevel
    case hyperion.WarnLevel:
        return zapcore.WarnLevel
    case hyperion.ErrorLevel:
        return zapcore.ErrorLevel
    case hyperion.FatalLevel:
        return zapcore.FatalLevel
    default:
        return zapcore.InfoLevel
    }
}
```

### Project Structure Notes

✅ **Structure Alignment Verified**:
- Adapter location follows monorepo pattern: `adapter/zap/`
- Independent `go.mod` as required for v2.0 architecture
- NoOp implementation already exists in `hyperion/logger_noop.go`
- Core interface defined in `hyperion/logger.go`

No structural conflicts identified. Implementation aligns with v2.0 core-adapter architecture.

[Source: docs/architecture/source-tree.md#v20-structure-current]

### Related Stories

**Previous Story (Epic 1)**:
- Epic 1 completed all core interfaces including `hyperion.Logger`
- NoOp Logger implementation available as reference
- Test coverage standards established (>80%)

**Current Epic Context**:
- This is story 2.1, first story in Epic 2 (Essential Adapters)
- Provides foundation for structured logging in production
- Required for subsequent stories that need logging

**Next Story**:
- Story 2.2 will likely implement GORM database adapter
- Both adapters (Zap + GORM) are required for example CRUD app in story 2.4

[Source: docs/prd/epic-2-essential-adapters.md#deliverables]

### Success Validation

Story is complete when:
1. ✅ All acceptance criteria met
2. ✅ Test coverage >= 80%
3. ✅ All linters pass (`make lint`)
4. ✅ All tests pass (`make test`)
5. ✅ Documentation complete
6. ✅ Integration with fx.Module working
7. ✅ Performance overhead < 5% vs native Zap

[Source: docs/prd/epic-2-essential-adapters.md#success-criteria]

---

**Story Timeline**: 5 working days (as per Epic 2 plan)
**Priority**: P0 (Essential adapter)
**Assigned To**: Developer Agent
**Epic**: Epic 2 - Essential Adapters (v2.1)

---

## ✅ Implementation Summary

**Completion Date**: 2025-10-02

### Final Metrics

| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| Test Coverage | ≥80% | 93.9% | ✅ |
| Test Count | - | 20 tests | ✅ |
| Lint Checks | Pass | All pass | ✅ |
| Code Lines | - | 1,336 lines | ✅ |

### Deliverables

- ✅ `adapter/zap/logger.go` - Core implementation (232 lines)
- ✅ `adapter/zap/module.go` - fx.Module export (26 lines)
- ✅ `adapter/zap/doc.go` - Package documentation (80 lines)
- ✅ `adapter/zap/logger_test.go` - Unit tests (15 tests, 447 lines)
- ✅ `adapter/zap/integration_test.go` - Integration tests (5 tests, 471 lines)
- ✅ `adapter/zap/go.mod` - Module declaration
- ✅ `adapter/zap/IMPLEMENTATION_REPORT.md` - Final report

### All Acceptance Criteria Met

1. ✅ Zap adapter implements `hyperion.Logger` interface (10/10 methods)
2. ✅ JSON and Console encoders supported
3. ✅ Dynamic log level adjustment (concurrent-safe)
4. ✅ File rotation with lumberjack v2.2.1
5. ✅ Configuration integration via Viper
6. ✅ Test coverage 93.9% (>80%)

### Next Steps

- Create Pull Request to develop branch
- Begin Story 2.2: GORM Database Adapter

**Story completed successfully!** 🎉
